
# rpup - R пакет для работы с базой данных ПУПа
rpup это пакеет который предназначен для работы с базой данных внутренней самописной ERP/CRM системы ПУП, по сути все функции пакета это обёртки над SQL запросами в которые просто прокидываются параметры.

## Начало работы с пакетом

При старте каждой новой сессии подключите пакет:

    library(rpup)

После подключения пакета вы увидите приветственное сообщение:

    Привет Alsey!
    Пакет rpup версии 0.9.0 подключен.
    Для начала работы с базой ПУПа установите следующие необходимые опции 

    # pup options
    options(pup.user     = 'имя пользователя базы данных',
            pup.password = 'пароль для подключения к базе данных')

При первом запуске рекомендую создать конфиг командой
`pup_create_config()`. После запуска функции в консоли запустится мастер
создания конфига, отвечайте по очереди на его вопросы.

    # сначала устанавливаем необходимые опции, если дефолтные не подходят
    options(
      pup.hostname='95.216.4.19',
      pup.dbname   = "pup"
    )

    # запускаем мастер создания конфига
    pup_create_config()

    Ваш логин в ПУПе: Alsey
    Ваш пароль в ПУПе: *********
    Имя пользователя в базе Пупа MySQL: alsey
    Пароль в базе Пупа MySQL: *********
    Конфиг успешно создан.

В дальнейшем при запуске пакета необходимые учётные данные будут
считываться с конфига.

Для подключения к базе данных ПУПа используйте команду
`pup_connection()`:

    pup_connection(
      username = 'username', 
      password = '*******', 
      hostname = '1.1.1.1', 
      port     = 3310,
      dbname   = 
    )

После подключения к базе данных ПУПа можно переходить непосредственно к
работе с пакетом.

## Функции пакета rpup

В этом блоке я опишу доступные в rpup функции для запроса данных и
приведу примеры кода.

*Таблица функций:*
- `pup_get_query()` - Чтение SQL запроса, функция принимает запрос строкой, либо в виде пути к SQL файлу
- `pup_get_table()` - Чтение определённой таблицы из БД ПУПа
- `pup_search_table()` - Поиск таблиц по названию
- `pup_get_bonuses()` - Получить данные о бонусах
- `pup_get_clients()` - Получить таблицу клиентов (контрагентов)
- `pup_get_currency_rates()` - Получить таблицу курсов валют
- `pup_get_expenses()` - Получить траты сотрудников
- `pup_get_orders()` - Получить данные по заявкам на услуги
- `pup_get_pf_task()` - Получить данные по задачам в Планфикс
- `pup_get_projects()` - Получить таблицу проект - услуг
- `pup_get_query_money()` - Получить таблицу запросов денег
- `pup_get_user_cert()` - Получить сертификаты сотрудников из ПУПа
- `pup_get_user_info()` - Получить таблицу сотрудников
- `pup_get_user_social_links()` - Получить ссылки на социальные сети из профиля сотрудника
- `pup_get_user_official_info()` - Получить официальные данные по трудоустройству сотрудников
- `pup_get_project_archive()` - Получить данные по архивации проектов
- `pup_get_project_expenses()` - Получить список трат по проектам
- `pup_get_user_leaders()` - Получить таблицу руководителей по заданным сотрудникам
- `pup_get_user_team()` - Получить список подчинённых по указанным сотрудникам
- `pup_get_usertask()` - Получить список задач по указанному сотруднику
- `pup_get_client_contacts()` - Получить список контактов клиентов
- `pup_get_client_balance()` - Получить таблицу остатков по балансу контрагентов
- `pup_get_vacs()` - Получить заявки на вакансии
- `pup_get_salary_reduce_2022()` - Данные по урезаниям ЗП в связи с войной в Украине 2022
- `pup_get_salary_compensation_2022()` - Данные по выплаченным компенсациям в связи урезаниям ЗП в связи с войной в Украине 2022
- `pup_get_additional_income()` - Данные по дополнительным (не клиентским) доходам.
- `pup_get_client_payments()` - Получить таблицу пополнений счетов (оплат) контрагентов
- `pup_get_attendance_journal()` - Запросить журнал посещаемости сотрудников

Примеры кода для работы с пакетом `rpup`:

``` r
library(rpup)

# подключение к базе ПУПа
pup_connection(hostname = '95.216.4.19')

# ищем таблицы в названии которых встречается слово payment
pup_search_table('payment')

# получить полный список всех таблиц можно так
pup_search_table('.*')

# Читам таблицу payment_report - списаний
pr <- pup_get_table(
  table   = 'payment_report', 
  fields  = c('pay_proj_id', 'Date', 'IM', 'FSR'), 
  filters = 'Date BETWEEN "2021-06-01" AND "2021-06-30"'
)

# Читаем sql запрос
## текст SQL запроса
sql <- '
    SELECT username, iduser, date_company
    FROM contacts
    WHERE date_company_out = "0000-00-00"
'
## чтение запроса
contacts <- pup_get_query(sql)

# Получить список сотрудников
employee <- pup_get_user_info(with_fired_users = FALSE)

# Получить список подчинённых по указанным сотрудникам
als_pix_teams <- pup_get_user_team(pup_user_ids = c(301, 483))

# Получить список руководителей по указанным сотрудникам
als_ash_dh <- pup_get_user_leaders(pup_user_ids = c(301, 460))
```

## Обновление данных в аналитической копии базы ПУПа

Пакет rpup позволяет внепланово обновить данные в таблицах аналитической
копии базы данных. Но, для обновления данных вам необходима привилегия в
ПУПе на использование entity. Открыть данную привелегию можно через Rock
или Dante.

Так же для обновления данных на Windows необходимо установить Git.

Обновление данных осуществляется функцией `pup_db_update()`.

Пример обновления таблиц contacts и agencies:

``` r
pup_db_update(tables = c('contacts', 'agencies'))
```

## Поддержка пакета

По всем вопросам работы с пакетом, и расширения его функционала
обращаться к [Alsey](https://t.me/AlexeySeleznev).
