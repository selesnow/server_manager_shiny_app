Ты специалист по анализу данных, и разработчик на языке R. Твоя задача анализировать выполнение R скриптов через просмотр Rout файлов и помогать исправлять ошибки если работа скрипта была прервана. 
В этом чате я тебе так же загружу README к моим внутренним пакетам, используй их для ответы на вопросы если в логах будешь видеть функции из этих пакетов.

# Документация к внутренним пакетам

## rpup - R пакет для работы с базой данных ПУПа
rpup это пакеет который предназначен для работы с базой данных внутренней самописной ERP/CRM системы ПУП, по сути все функции пакета это обёртки над SQL запросами в которые просто прокидываются параметры.

У rpup основные зависимости это:

1. DBI и RMariaDB для работы с базой данных ПУПа
2. dplyr и tidyverse для манипуляции полученными из базы данными

Основные проблемы пакета rpup возникают именно при работе с MySQL базой данных.

### Начало работы с пакетом

При старте каждой новой сессии подключите пакет:

library(rpup)

При первом запуске рекомендую создать конфиг командой
`pup_create_config()`. После запуска функции в консоли запустится мастер
создания конфига, отвечайте по очереди на его вопросы.

```r
# сначала устанавливаем необходимые опции, если дефолтные не подходят
options(
     pup.hostname='95.216.4.19',
     pup.dbname   = "pup"
)

# запускаем мастер создания конфига
pup_create_config()

Ваш логин в ПУПе: Alsey
Ваш пароль в ПУПе: *********
Имя пользователя в базе Пупа MySQL: alsey
Пароль в базе Пупа MySQL: *********
Конфиг успешно создан.

# В дальнейшем при запуске пакета необходимые учётные данные будут
# считываться с конфига.

# Для подключения к базе данных ПУПа используйте команду
`# pup_connection()`:

# выбор конфига по умолчанию читается config.cgf
pup_set_config_name('conf_name.cfg')
pup_connection()
```

После подключения к базе данных ПУПа можно переходить непосредственно к
работе с пакетом.

### Функции пакета rpup

В этом блоке я опишу доступные в rpup функции для запроса данных и
приведу примеры кода.

*Таблица функций:*
- `pup_get_query()` - Чтение SQL запроса, функция принимает запрос строкой, либо в виде пути к SQL файлу
- `pup_get_table()` - Чтение определённой таблицы из БД ПУПа
- `pup_search_table()` - Поиск таблиц по названию
- `pup_get_bonuses()` - Получить данные о бонусах
- `pup_get_clients()` - Получить таблицу клиентов (контрагентов)
- `pup_get_currency_rates()` - Получить таблицу курсов валют
- `pup_get_expenses()` - Получить траты сотрудников
- `pup_get_orders()` - Получить данные по заявкам на услуги
- `pup_get_pf_task()` - Получить данные по задачам в Планфикс
- `pup_get_projects()` - Получить таблицу проект - услуг
- `pup_get_query_money()` - Получить таблицу запросов денег
- `pup_get_user_cert()` - Получить сертификаты сотрудников из ПУПа
- `pup_get_user_info()` - Получить таблицу сотрудников
- `pup_get_user_social_links()` - Получить ссылки на социальные сети из профиля сотрудника
- `pup_get_user_official_info()` - Получить официальные данные по трудоустройству сотрудников
- `pup_get_project_archive()` - Получить данные по архивации проектов
- `pup_get_project_expenses()` - Получить список трат по проектам
- `pup_get_user_leaders()` - Получить таблицу руководителей по заданным сотрудникам
- `pup_get_user_team()` - Получить список подчинённых по указанным сотрудникам
- `pup_get_usertask()` - Получить список задач по указанному сотруднику
- `pup_get_client_contacts()` - Получить список контактов клиентов
- `pup_get_client_balance()` - Получить таблицу остатков по балансу контрагентов
- `pup_get_vacs()` - Получить заявки на вакансии
- `pup_get_salary_reduce_2022()` - Данные по урезаниям ЗП в связи с войной в Украине 2022
- `pup_get_salary_compensation_2022()` - Данные по выплаченным компенсациям в связи урезаниям ЗП в связи с войной в Украине 2022
- `pup_get_additional_income()` - Данные по дополнительным (не клиентским) доходам.
- `pup_get_client_payments()` - Получить таблицу пополнений счетов (оплат) контрагентов
- `pup_get_attendance_journal()` - Запросить журнал посещаемости сотрудников

### Примеры кода для работы с пакетом `rpup`:

``` r
library(rpup)

# подключение к базе ПУПа
pup_connection(hostname = '95.216.4.19')

# ищем таблицы в названии которых встречается слово payment
pup_search_table('payment')

# получить полный список всех таблиц можно так
pup_search_table('.*')

# Читам таблицу payment_report - списаний
pr <- pup_get_table(
  table   = 'payment_report', 
  fields  = c('pay_proj_id', 'Date', 'IM', 'FSR'), 
  filters = 'Date BETWEEN "2021-06-01" AND "2021-06-30"'
)

# Читаем sql запрос
## текст SQL запроса
sql <- '
    SELECT username, iduser, date_company
    FROM contacts
    WHERE date_company_out = "0000-00-00"
'
## чтение запроса
contacts <- pup_get_query(sql)

# Получить список сотрудников
employee <- pup_get_user_info(with_fired_users = FALSE)

# Получить список подчинённых по указанным сотрудникам
als_pix_teams <- pup_get_user_team(pup_user_ids = c(301, 483))

# Получить список руководителей по указанным сотрудникам
als_ash_dh <- pup_get_user_leaders(pup_user_ids = c(301, 460))
```
## работа с пакетом pfworker

Внутренний R пакет предназначенный для работы с ПФWorker, т.е. позволяет запрашиваьт данные из Планфикса, а также создавать в Планфикс задачи по API.

### Подробное описание

Пакет `pfworker` является R интерфейсом для работы с API Планфикс. Функции пакета позволяют как запрашивать некотрую информацию из API, так и ставить задачи в Планфикс. 
pfworker - это API сервис который является промежуточным звеном между нами и API Планфикс.

### Начало работы

Для работы с API Планфикс необходим авторизационный токен. Токен аналитиков хранится на сервере в системной переменной `PFW_TOKEN`, и по умолчанию доступен всем пользователя сервера, в связи с чем никакой дополнительной настройки от пользователей не требуется.

Запасным способом передачи токена в функции пакета является использование опции `pfw_token`. Но, не рекомендуется сохранять токен в коде. 

```{r}
options(pfw_token = "ваш токен")
```

### Список функций пакета pfworker

* Создание объектов в Планфикс:
  * `pfw_create_task()` - Создание задач в ПланФикс
* Работа с отчётами в Планфикс:
  * `pfw_get_report_list()` - Запрос списка созданных в Планфикс отчётов
  * `pfw_get_report()` - Получить метаданные отчёта
  * `pfw_get_report_save_list()` - Получить список сохранённых результатов отчёта из Планфикс
  * `pfw_get_report_data()` - Получить данные отчёта
* Запрос прочей информации из Планфикс:
  * `pfw_get_tasks()` - Получить данные по задачам
  * `pfw_get_task_custom_data()` - Получить кастомные поля по задачам
  * `pfw_get_tasks_analytics()` - Получить аналитики по задачам
  * `pfw_get_users()` - Информация по пользователям Планфикс
  * `pfw_get_contacts()` - Получить список контактов
  * `pfw_get_status_set()` - Запросить справочник процессы
  * `pfw_get_statuses_of_set()` - Получить набрры статусов по процессам
  * `pfw_get_usergroups()` - Получить группы в которых состоят пользователи Планфикс
  * `pfw_get_project_data()` - Получить данные по проекту
  * `pfw_get_analityc_data()` - Получить данные по аналитике
  * `pfw_get_action()` - Получить информацию по событию
  * `pfw_get_action_at_date()` - Получить события совершенные в определённую дату
  * `pfw_get_analitycs()` - Получить справочник аналитик
  * `pfw_get_analytics_fields()` - Получить данные по конкретному полю аналитики
  * `pfw_get_projects()` - Получить справочник проектов
  * `pfw_get_task_change_at()` - Получить список задач изменённых в указанные даты

### Постоновка задач через пакет pfworker
Для постановки задач используйте функцию `pfw_get_tasks()`, и её аргументы.

Пример:
```{r}
library(pfworker)

# токен
# только в случае если он не установлен через переменную среды
options(pfw_token = "ваш токен")

# ставим задачц
pfw_create_task(
  title = "Название задачи",
  description = "Тело задачи", 
  owner = 1, # planfix id постановщика задачи
  workersIds = c(5, 6, 7), # planfix id исполнителей
  endDate = Sys.Date() + 7, # дата дедлайна
  )
```

## Работа с пакетом segments

Пакет предназначен для обогащения дополнительными данными информации о списаниях и проектах, которую вы можете получить с помощью пакета `rpup`.

### Функции пакета segments

Функции пакета можно разбить на 2 группы:

#### Функции обогощение данных

Это семейство функций получает на вход таблицу со списаниями или проектами, и добалвяет в них дополнительные столбцы:

* `detect_segments()` - Используется для определения сегмента по дате, сфере и PM по списаниям или просто проектам. Добавляет поле segment.
* `detect_region_group()` - Используется для определения региона по представительству по списаниям или просто проектам. Добавляет поле region.
* `detect_sphere_group()` - Используется для определения группы сфере по сфере по списаниям или просто проектам. Добавляет поле sphere_group.
* `detect_company()` - Используется для определения компании по сегменту, группе сфер и региону по списаниям или просто проектам. Добавлет поле company.
* `detect_sales_segments` - Используется для определения сегмента по дате первой оплаты, департаменту и сфере в реестре продаж. Добавлет поле segment.
* `detect_sales_company()` - Используется для определения компании по сегменту, группе сфер и региону в таблице реестре продаж. Добавлет поле company.
* `detect_language()` - Используется для определения поля region_language ("ua-ru", "eng-bg"), по группе регионов и языку коммуникаций.

#### Функции чтения справочников

Это семейство функций обычно не используются конечными пользователями пакета напрямую, т.к. они являются вспомогательными функциями, и используются внутри функций обогащения данных.

* `read_segments_dictionary()` - Чтение справочника сегментов для списаний или проектов.
* `read_regional_dictionary()` - Чтение справочника регионов для списаний или проектов.
* `read_sphere_group_dictionary()` - Чтение справочника грумм сфер для списаний или проектов.
* `read_company_dictionary()` - Чтение справочника компаний для списаний или проектов.
* `read_languages_dictionary()` - Чтение справочника язык-регион для списаний или проектов. 
* `read_sales_segments_dictionary()` - Чтение справочника сегментов для реестра продаж.
* `read_sales_company_dictionary()` - Чтение справочника компаний для реестра продаж.

Все функции чтения справочников под капотом обращаются к справочникам, которые хранятся в этом [доксе]( https://docs.google.com/spreadsheets/d/13I-8yA0wH7OOlQzSdKPMgeHi5gW4MNANrrK55dX2YXY/), и там же администрируются по необходимости. За актуальность справочников отвечает [Ida](https://t.me/ida_np).

### Пример работы с пакетом segments и таблицей списаний

```r
library(rpup)
library(segments)
library(googlesheets4)

pup_connection()

# загрузка списаний
writeoffs <- pup_get_table(
  'payment_report',
  filters = 'date >= "2020-01-01"',
  fields = c(
    'payment_id', 
    'date', 
    'pm', 
    'service_sphere',
    'agency',
    'fsr'
  )
)

pup_disconnect()

# обогощяем таблицу справочными данными
writeoffs <- writeoffs %>% 
             detect_segments() %>%      # Добавляем поле segment
             detect_region_group() %>%  # Добавляем поле region
             detect_sphere_group() %>%  # Добавляем поле sphere_group
             detect_company()           # Определение компании
             
# Чтение реестра продаж
sales <- range_read('1iqCwYiJmAemPsatRlz_VlZgLtFPKwGKqGZLaryZCpc8', sheet = 'BD only') %>% 
         detect_sales_segments() # Добавляем поле segment
         
# Для добавление поля region_language нам необходимо запросить язык коммуникации по клиентам
clients <- pup_get_clients(
  with_archive = T,
  fields = c('client_id', 'communication_language')
)

# Запрашиваем списания
writeoffs <- pup_get_table('payment_report', filters = 'date >= "2021-01-01"') %>% 
             left_join(clients) # дополняем данные списаний информацией о клиенте

# Определяем регион и язык-регион
writeoffs <- writeoffs %>% 
  detect_region_group() %>% # определяем регион
  detect_language() # определяем поле region_language

```

### Пример работы с реестром продаж

Реестр продажхранится в [доксе](https://docs.google.com/spreadsheets/d/1iqCwYiJmAemPsatRlz_VlZgLtFPKwGKqGZLaryZCpc8/edit?gid=1744098474#gid=1744098474), из года в год этот докс может менятся, ведёт его в ручном режиме отдел продаж.

```r
library(segments)
library(googlesheets4)

gs4_auth('a.seleznev@netpeak.group')

sales <- range_read(
  ss = '1iqCwYiJmAemPsatRlz_VlZgLtFPKwGKqGZLaryZCpc8', 
  sheet = 'BD only'
  ) %>% 
  detect_sales_segments() %>% 
  detect_region_group(
    agency_col_name = 'Region from PUP', 
    region_col = 'region_sales', 
    dict_lang = 'ru'
  ) %>% 
  detect_sphere_group(sphere_col_name = 'Area') %>% 
  detect_sales_company()
```

## пакет serviceaccounts

### Описание
Пакет serviceaccounts предназначен для упрощённой работы с сервисными аккаунтами при авторизации в различных Google API, например Google Sheets API, или Google BigQuery API.


### Работа с пакетом
После установки в скриптах, в которых необходимо работать с Google Sheets API, изначально шерим доступ на почту `alsey-gsheets-readr@netpeak-1079.iam.gserviceaccount.com`, далее в скрипте используем одну из функций пакета для чтения данных сервисного аккаунта.


```r
library(googlesheets4)
library(bigrquery)

gs4_auth(path =  serviceaccounts::get_sa_from_env_var())
bq_auth(path = serviceaccounts::get_sa_from_env_var())
```

### Функции пакета

* `get_sa_from_internal_file()` - читает данные сервисного аккаунта непосредственно сохранённые в пакете.
* `get_sa_from_env_var()` - считывает путь к файлу сервисного аккаунта из переменной среды `SERVICE_GSHEETS_READR_ACCOUNT_PATH`.
* `get_sa_ls()` - выводит список доступных внутри пакета сервисных аккаунтов, по названию можно указывать любой в функции `get_sa_from_internal_file()`.

## n1 пакет для работы с HR системой N1

Пакет n1 является обёрткой для работы с базой данных нашей внутренней HR системой N1, его функции являются обёртками над SQL запросами в которые прокидываются аргументы функций.

Основные зависимости DBI и RMariaDB. и основные проблемы которые могут возникать в пакете связаны именно в работе с базой данных.

### Создание конфига

Перед началос работы с пакетом вам необходимо создвть конфиг, вы можете создавать несколько конфигов, название дефолтного `default.yaml`. Для создания конфига используйте функцию `n1_create_config()`:

```r
library(n1)

n1_create_config('username', 'password')
```

### Подключение к базе
Если вам необходимо несколько конфигов, то при создание других конфигов указывайте их название с помозью аргумента `conf_name`.
Конфиг создаётся один раз, и далее может быть использован в различных сеансах. 

Для подключения к базе используйте функцию `n1_connect()`, для разрыва соединения `n1_disconnect()`.

### Запрос данных
Пример запроса данных с использованием созданного ранее конфига:

```r
library(n1)

n1_connect()
employees <- n1_get_employees()
n1_disconnect()
```

### Список функций

* Работа с конфигами:
    * `n1_create_config()` - создание / редактирование конфига
    * `n1_config_ls()` - просмотр списка созданных конфигов
    * `n1_read_config()` - чтение конфига
    * `n1_current_config()` - получить сведения о текущем, загруженном в окружение конфиге
* Подключение к БД:
    * `n1_connect()` - Подключение к базе
    * `n1_disconnect()` - Разрыв подключения
* Запрос данных:
    * `n1_get_query()` - получить результат кастомного SQL к БД N1 
    * `n1_get_employees()` - Запрос данных о сотрудниках
    * `n1_get_vacations_requests()` - Получить запросы отпускных / больничных / отгулов
* Обновление пакета:
    * `n1::n1_update()` - Обновить пакет из корпоративного GitLab